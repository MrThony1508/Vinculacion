{% extends 'base.html' %}
{% block contenido %}

<style>
    :root {
        --utc-blue: #173D62;
    }
    .map-container { 
        border-radius: 20px; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        border: 1px solid #e2e8f0; 
    }
    
    .custom-infowindow { padding: 8px; font-family: 'Inter', sans-serif; max-width: 260px; }
    .custom-infowindow h6 { color: var(--utc-blue); font-weight: 800; margin-bottom: 5px; border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 0.9rem; }
    
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px; }
    .info-item { font-size: 0.7rem; background: #f8fafc; padding: 4px; border-radius: 4px; border: 1px solid #e2e8f0; }
    .info-label { font-weight: bold; color: #64748b; display: block; text-uppercase: uppercase; font-size: 0.55rem; }

    .docente-tag { font-size: 0.75rem; font-weight: bold; color: #dc2626; margin: 5px 0; display: block; }
    .estudiantes-lista { margin: 5px 0; padding-left: 15px; font-size: 0.8rem; color: #334155; max-height: 80px; overflow-y: auto; list-style-type: disc; }
    
    .badge-tipo { background: #0ea5e9; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.65rem; font-weight: bold; }
</style>

<div class="container py-4">
    <div class="text-center mb-4">
        <h1 class="fw-800" style="color: var(--utc-blue);">
            <i class="bi bi-geo-alt-fill text-danger me-2"></i>Geolocalización UTC
        </h1>
    </div>

    <div class="filter-card mb-4 bg-white p-3 rounded shadow-sm border">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small fw-bold">CARRERA</label>
                <select id="carreraSelect" class="form-select bg-light border-0">
                    <option value="todas">Todas las carreras</option>
                    <option value="Sistemas de información">Sistemas de información</option>
                    <option value="Software">Software</option>
                    <option value="Electromecánica">Electromecánica</option>
                    <option value="Industrial">Industrial</option>
                    <option value="Electricidad">Electricidad</option>
                    <option value="Hidráulica">Hidráulica</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">TIPO DE PRÁCTICA</label>
                <select id="practicaSelect" class="form-select bg-light border-0">
                    <option value="todas">Todos los tipos</option>
                    <option value="PPP">Prácticas Pre-profesionales (PPP)</option>
                    <option value="Servicio Comunitario">Servicio Comunitario</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">BUSCAR ESTUDIANTE</label>
                <input type="text" id="buscadorNombre" class="form-control bg-light border-0" placeholder="Nombre...">
            </div>
        </div>
    </div>

    <div class="map-container">
        <div id="map" style="height: 600px; width: 100%;"></div>
    </div>
</div>

{{ estudiantes|json_script:"estudiantes-data" }}

<script>
let map;
let markers = [];
let activeInfoWindow = null;

function initMap() {
    const dataElement = document.getElementById("estudiantes-data");
    if (!dataElement) return;

    const listaEstudiantes = JSON.parse(dataElement.textContent);
    
    // Coordenadas iniciales (Latacunga)
    const centro = { lat: -0.9333, lng: -78.6167 };

    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: centro,mapTypeControl: false,
        streetViewControl: false,
        styles: [
            { "featureType": "poi", "stylers": [{ "visibility": "off" }] }
        ]
    });

    function agregarMarcadores() {
        // Limpiar infoWindow abierto
        if (activeInfoWindow) activeInfoWindow.close();
        
        // Limpiar marcadores previos
        markers.forEach(m => m.setMap(null));
        markers = [];

        const fCarrera = document.getElementById('carreraSelect').value;
        const fPractica = document.getElementById('practicaSelect').value;
        const fNombre = document.getElementById('buscadorNombre').value.toLowerCase();

        const grupos = {};

        listaEstudiantes.forEach(est => {
            // Validaciones de filtros
            if (fCarrera !== 'todas' && est.carrera !== fCarrera) return;
            if (fPractica !== 'todas' && est.tipo_practica !== fPractica) return;
            const nombreCompleto = `${est.nombre} ${est.apellido}`.toLowerCase();
            if (fNombre && !nombreCompleto.includes(fNombre)) return;

            // Agrupar por coordenadas exactas
            const key = `${est.lat}_${est.lng}`;
            if (!grupos[key]) {
                grupos[key] = {
                    lat: est.lat,
                    lng: est.lng,
                    grupo_nombre: est.grupo_nombre || "Ubicación de Prácticas",
                    tipo_practica: est.tipo_practica,
                    semestre: est.semestre,
                    periodo: est.periodo,
                    docente: est.docente,
                    carrera: est.carrera,
                    integrantes: []
                };
            }
            grupos[key].integrantes.push(`${est.nombre} ${est.apellido}`);
        });

        // Dibujar un marcador por cada ubicación única
        Object.values(grupos).forEach(g => {
            const marker = new google.maps.Marker({
                position: { lat: parseFloat(g.lat), lng: parseFloat(g.lng) },
                map: map,
                title: g.grupo_nombre,
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                    fillColor: (g.tipo_practica === 'PPP') ? '#173D62' : '#dc2626',
                    fillOpacity: 0.9,
                    strokeWeight: 1,
                    strokeColor: "#ffffff",
                    scale: 7
                }
            });

            const integrantesHtml = g.integrantes.map(i => `<li>${i}</li>`).join('');

            const contentString = `
                <div class="custom-infowindow">
                    <h6>${g.grupo_nombre}</h6>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">MODALIDAD</span>
                            <span class="badge-tipo">${g.tipo_practica}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">SEMESTRE</span>
                            <strong>${g.semestre || 'N/A'}</strong>
                        </div>
                    </div>
                    <div class="info-item mb-2">
                        <span class="info-label">PERÍODO ACADÉMICO</span>
                        <small>${g.periodo || 'No definido'}</small>
                    </div>
                    <span class="docente-tag"><i class="bi bi-person-badge me-1"></i>Docente: ${g.docente}</span>
                    <p class="mb-1 mt-2 small"><strong>Estudiantes vinculados:</strong></p>
                    <ul class="estudiantes-lista">${integrantesHtml}</ul>
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({ content: contentString });

            marker.addListener('click', () => {
                if (activeInfoWindow) activeInfoWindow.close();
                infoWindow.open(map, marker);
                activeInfoWindow = infoWindow;
            });

            markers.push(marker);
        });
    }

    // Listeners
    document.getElementById('carreraSelect').addEventListener('change', agregarMarcadores);
    document.getElementById('practicaSelect').addEventListener('change', agregarMarcadores);
    document.getElementById('buscadorNombre').addEventListener('input', agregarMarcadores);

    // Carga inicial
    agregarMarcadores();
}
</script>

<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD0Ko6qUa0EFuDWr77BpNJOdxD-QLstjBk&callback=initMap">
</script>

{% endblock %}